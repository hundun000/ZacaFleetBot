## 架构简介

子项目mirai-bot: 下称“bot核心包”，提供上述bot功能。

> 通过IConsole来对接他的使用者，不关心IConsole的实现。

子项目mirai-server: 使用“bot核心包”，使用mirai-core，输出SpringBootApplication。启动后可连接QQ上线bot。

> 包含IConsole的第一种实现。

子项目mirai-plugin: 使用“bot核心包”，输出mirai-console-plugin。需通过mirai-console启动。

> 包含IConsole的第二种实现。

把该项目放进mirai生态图应该是这样：
[![](https://mermaid.ink/img/eyJjb2RlIjoiZmxvd2NoYXJ0IExSXG4gICAgY2xhc3NEZWYgY29yZWhpZ2hsaWdodCBmaWxsOiNmOTYsc3Ryb2tlOiMzMzMsc3Ryb2tlLXdpZHRoOjNweDtcbiAgICBjbGFzc0RlZiBoaWdobGlnaHQgZmlsbDojZjg4LHN0cm9rZTojMzMzLHN0cm9rZS13aWR0aDozcHhcbiAgICBjbGFzc0RlZiBteWxpZ2h0IGZpbGw6IzRBRixzdHJva2U6IzMzMyxzdHJva2Utd2lkdGg6M3B4XG5cbiAgICBib3Rsb2dpYyjmnKzpobnnm67nmoQ8YnIvPue6r2JvdOmAu-i-kTxici8-5aSE55CG5oyH5Luk5ZCN5ZKM5oyH5Luk5Y-C5pWwKTo6Om15bGlnaHRcblxuXG4gICAgc3ViZ3JhcGggbWlyYWkgW1wiTWlyYWkg5qGG5p62XCJdXG4gICAgICAgIG1pcmFpY29yZWFwaShtaXJhaS1jb3JlLWFwaSk6Ojpjb3JlaGlnaGxpZ2h0XG4gICAgICAgIG1pcmFpY29yZXFxYW5kcm9pZChcIm1pcmFpLWNvcmU8YnIvPihRUUFuZHJvaWQg5Y2P6K6uKVwiKVxuICAgICAgICBtaXJhaWNvcmVxcWFuZHJvaWQgLS0-IHzmj5DkvpvljY_orq58bWlyYWljb3JlYXBpXG4gICAgZW5kXG4gICAgbWlyYWlpbnRlcmZhY2UoXCLmnKzpobnnm67ovpPlh7rnmoQ8YnIvPuacuuWZqOS6uueoi-W6j1wiKTo6Om15bGlnaHRcbiAgICBib3Rsb2dpYyAtLT4gfOiiq-S9v-eUqHxtaXJhaWludGVyZmFjZVxuICAgIGJvdGxvZ2ljIC0tPiB86KKr5L2_55SofHlvdXJtaXJhaXBsdWdpblxuICAgIG1pcmFpY29yZWFwaSAtLT4gfOWwgeijheWfuuehgOWKn-iDvXxtaXJhaWNvbnNvbGViYWNrZW5kXG4gICAgbWlyYWljb3JlYXBpIC0tPiB85bCB6KOF5Z-656GA5Yqf6IO9fGJvdGxvZ2ljXG4gICAgc3ViZ3JhcGggbWlyYWljb25zb2xlIFtcIk1pcmFpIENvbnNvbGVcIl1cbiAgICAgICAgbWlyYWljb25zb2xlYmFja2VuZChcIkJhY2tFbmRcIilcbiAgICAgICAgbWlyYWljb25zb2xlZnJvbnRlbmQtdGVybWluYWwoXCJGcm9udEVuZDogdGVybWluYWxcIilcbiAgICAgICAgbWlyYWljb25zb2xlZnJvbnRlbmQtYW5kcm9pZChcIkZyb250RW5kOiBBbmRyb2lkXCIpXG4gICAgICAgIG1pcmFpY29uc29sZWJhY2tlbmQgLS0-IG1pcmFpY29uc29sZWZyb250ZW5kLXRlcm1pbmFsXG4gICAgICAgIG1pcmFpY29uc29sZWJhY2tlbmQgLS0-IG1pcmFpY29uc29sZWZyb250ZW5kLWFuZHJvaWRcbiAgICBlbmRcbiAgICBzdWJncmFwaCBjb25zb2xlcGx1Z2lucyBbXCJNaXJhaSBDb25zb2xlIOaPkuS7tlwiXVxuICAgICAgICB5b3VybWlyYWlwbHVnaW4oXCLmnKzpobnnm67ovpPlh7rnmoQ8YnIvPiBDb25zb2xlIOaPkuS7tlwiKTo6Om15bGlnaHRcbiAgICAgICAgY2hhdGNvbW1hbmQoXCJjaGF0LWNvbW1hbmQg5o-S5Lu2XCIpOjo6aGlnaGxpZ2h0XG4gICAgZW5kXG4gICAgeW91cm1pcmFpcGx1Z2luIC0tPiBtaXJhaWNvbnNvbGViYWNrZW5kXG4gICAgY2hhdGNvbW1hbmQgLS0-IG1pcmFpY29uc29sZWJhY2tlbmQiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlLCJhdXRvU3luYyI6dHJ1ZSwidXBkYXRlRGlhZ3JhbSI6ZmFsc2V9)](https://mermaid-js.github.io/mermaid-live-editor/edit/##eyJjb2RlIjoiZmxvd2NoYXJ0IExSXG4gICAgY2xhc3NEZWYgY29yZWhpZ2hsaWdodCBmaWxsOiNmOTYsc3Ryb2tlOiMzMzMsc3Ryb2tlLXdpZHRoOjNweDtcbiAgICBjbGFzc0RlZiBoaWdobGlnaHQgZmlsbDojZjg4LHN0cm9rZTojMzMzLHN0cm9rZS13aWR0aDozcHhcbiAgICBjbGFzc0RlZiBteWxpZ2h0IGZpbGw6IzRBRixzdHJva2U6IzMzMyxzdHJva2Utd2lkdGg6M3B4XG5cbiAgICBib3Rsb2dpYyjmnKzpobnnm67nmoTnuq9ib3TpgLvovpE8YnIvPuWkhOeQhuaMh-S7pOWQjeWSjOaMh-S7pOWPguaVsCk6OjpteWxpZ2h0XG5cblxuICAgIHN1YmdyYXBoIG1pcmFpIFtcIk1pcmFpIOahhuaetlwiXVxuICAgICAgICBtaXJhaWNvcmVhcGkobWlyYWktY29yZS1hcGkpOjo6Y29yZWhpZ2hsaWdodFxuICAgICAgICBtaXJhaWNvcmVxcWFuZHJvaWQoXCJtaXJhaS1jb3JlPGJyLz4oUVFBbmRyb2lkIOWNj-iurilcIilcbiAgICAgICAgbWlyYWljb3JlcXFhbmRyb2lkIC0tPiB85o-Q5L6b5Y2P6K6ufG1pcmFpY29yZWFwaVxuICAgIGVuZFxuICAgIG1pcmFpaW50ZXJmYWNlKFwi5pys6aG555uu6L6T5Ye655qEPGJyLz7mnLrlmajkurrnqIvluo9cIik6OjpteWxpZ2h0XG4gICAgYm90bG9naWMgLS0-IHzooqvkvb_nlKh8bWlyYWlpbnRlcmZhY2VcbiAgICBib3Rsb2dpYyAtLT4gfOiiq-S9v-eUqHx5b3VybWlyYWlwbHVnaW5cbiAgICBtaXJhaWNvcmVhcGkgLS0-IHzlsIHoo4Xln7rnoYDlip_og718bWlyYWljb25zb2xlYmFja2VuZFxuICAgIG1pcmFpY29yZWFwaSAtLT4gfOWwgeijheWfuuehgOWKn-iDvXxib3Rsb2dpY1xuICAgIHN1YmdyYXBoIG1pcmFpY29uc29sZSBbXCJNaXJhaSBDb25zb2xlXCJdXG4gICAgICAgIG1pcmFpY29uc29sZWJhY2tlbmQoXCJCYWNrRW5kXCIpXG4gICAgICAgIG1pcmFpY29uc29sZWZyb250ZW5kLXRlcm1pbmFsKFwiRnJvbnRFbmQ6IHRlcm1pbmFsXCIpXG4gICAgICAgIG1pcmFpY29uc29sZWZyb250ZW5kLWFuZHJvaWQoXCJGcm9udEVuZDogQW5kcm9pZFwiKVxuICAgICAgICBtaXJhaWNvbnNvbGViYWNrZW5kIC0tPiBtaXJhaWNvbnNvbGVmcm9udGVuZC10ZXJtaW5hbFxuICAgICAgICBtaXJhaWNvbnNvbGViYWNrZW5kIC0tPiBtaXJhaWNvbnNvbGVmcm9udGVuZC1hbmRyb2lkXG4gICAgZW5kXG4gICAgc3ViZ3JhcGggY29uc29sZXBsdWdpbnMgW1wiTWlyYWkgQ29uc29sZSDmj5Lku7ZcIl1cbiAgICAgICAgeW91cm1pcmFpcGx1Z2luKFwi5pys6aG555uu6L6T5Ye655qEPGJyLz4gQ29uc29sZSDmj5Lku7ZcIik6OjpteWxpZ2h0XG4gICAgICAgIGNoYXRjb21tYW5kKFwiY2hhdC1jb21tYW5kIOaPkuS7tlwiKTo6OmhpZ2hsaWdodFxuICAgIGVuZFxuICAgIHlvdXJtaXJhaXBsdWdpbiAtLT4gbWlyYWljb25zb2xlYmFja2VuZFxuICAgIGNoYXRjb21tYW5kIC0tPiBtaXJhaWNvbnNvbGViYWNrZW5kIiwibWVybWFpZCI6IntcbiAgXCJ0aGVtZVwiOiBcImRlZmF1bHRcIlxufSIsInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjpmYWxzZX0)


## 子项目mirai-bot

主要使用的库：mirai-core + mongoDB + openfeign

### java包/java基类说明

#### Character 角色

为了支持该bot可以在不同Q群表现不同行为，使用【Character】区分。

例如，在明日方舟群，配置的角色为Amiya；在舰C群，配置的角色为PrinzEugen。

进一步的，可以为一个Q群配置多个角色。如果一个群里既有明日方舟玩家和舰C玩家，可以为该群配置Amiya+PrinzEugen。此时两个角色对输入的响应存在优先级甚至更复杂的调度策略（TODO）。

单例。Character无上下文。

#### cp包

每一个第三方服务封装成为一个CpService。CpService与mirai无关，可脱离mirai运行。

#### Function 功能

> 自己造了一遍轮子，才发现mirai-console里包含相同思路的实现。下文的Statement对应了net.mamoe.mirai.console.command。

连接CpService和Character。是Character总体功能的组成单元，即每个Character实际是在使用若干Function。

鉴于Function需要能被任意Character使用，所以只应有Character依赖Function，而Function不应依赖某个具体Character。

单例。若有需要，在内部自行实现区分不同session的上下文。

#### SubFunction 功能

枚举。用于区分一个Function下个最小粒度的功能。例如“创建事项提醒”和“查询事项提醒”、“删除事项提醒”分别是RemiderFunction下的3个SubFunction。

#### Statement 指令

原始输入MessageChain与Function解耦。原始输入MessageChain将被Character处理为一个Statement，正确地填充Statement的成员变量，Statement作为Function的输入。

Function只使用Statement（的成员变量），不关心原始输入。进一步的，甚至Function不关心原始输入是否来自Mira框架。

目的是实现如下功能：假设Amiya和PrinzEugen都使用查微博功能WeiboFuction，但是希望调用功能的语法不同，例如分别是“阿米娅 看看饼”和“欧根 查看镇守府情报”。

所以Amiya和PrinzEugen需要把上述两种原始输入处理成同样的Statement(subFunction=SubFunction.WEIBO_SHOW_LATEST)，再将其输入WeiboFuction。

#### Parser 语法分析器

把MessageChain处理成Statement使用的是Parser。参考编译原理。但目前的Parser并没有预期的那么有效。

开发者可以自行实现任意一种把MessageChain处理成Statement的方式，替换parser。


## 子项目mirai-server

主要使用的库：SpringBoot

> SpringConsole是IConsole的一种实现。该子项目从yml加载“bot核心包”启动所需的配置，提供了一些能直接调用Character或CpService的方法的http-api用于调试。

## 子项目mirai-plugin

> ConsoleAdapter是IConsole的一种实现，在“bot核心包”与mirai-console之间转发输入/输出。以mirai-console-plugin推荐的方式加载“bot核心包”启动所需的配置。